<Window x:Class="FolderIconManager.GUI.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:FolderIconManager.GUI"
        Title="Folder Icon Manager" 
        Height="750" Width="1100"
        MinHeight="500" MinWidth="800"
        Background="{StaticResource BackgroundDarkBrush}"
        WindowStartupLocation="CenterScreen"
        Closing="Window_Closing"
        Loaded="Window_Loaded">
    
    <Window.DataContext>
        <local:MainViewModel/>
    </Window.DataContext>

    <Window.InputBindings>
        <KeyBinding Key="I" Modifiers="Ctrl" Command="{Binding SetIconCommand}"/>
        <KeyBinding Key="E" Modifiers="Ctrl" Command="{Binding OpenInExplorerCommand}"/>
        <KeyBinding Key="C" Modifiers="Ctrl" Command="{Binding CopyPathCommand}"/>
        <KeyBinding Key="Z" Modifiers="Ctrl" Command="{Binding UndoCommand}"/>
    </Window.InputBindings>

    <Grid Margin="12">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="180"/>
        </Grid.RowDefinitions>

        <!-- Header / Folder Selection -->
        <Border Grid.Row="0" Background="{StaticResource BackgroundMediumBrush}" 
                CornerRadius="6" Padding="12" Margin="0,0,0,8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Folder Path -->
                <TextBox Grid.Column="0" Grid.Row="0"
                         Text="{Binding FolderPath, UpdateSourceTrigger=PropertyChanged}"
                         Style="{StaticResource ModernTextBox}"
                         VerticalContentAlignment="Center"
                         Margin="0,0,8,0"/>

                <!-- Browse Button -->
                <Button Grid.Column="1" Grid.Row="0"
                        Content="Browse..."
                        Command="{Binding BrowseCommand}"
                        Style="{StaticResource ModernButton}"
                        Margin="0,0,8,0"/>

                <!-- Scan Button -->
                <Button Grid.Column="2" Grid.Row="0"
                        Content="ðŸ” Scan"
                        Command="{Binding ScanCommand}"
                        Style="{StaticResource PrimaryButton}"
                        IsEnabled="{Binding CanScan}"
                        Margin="0,0,8,0"/>

                <!-- Options Row -->
                <StackPanel Grid.Column="0" Grid.Row="1" Grid.ColumnSpan="3" 
                            Orientation="Horizontal" Margin="0,10,0,0">
                    <CheckBox Content="Include subfolders" 
                              IsChecked="{Binding IncludeSubfolders}"
                              Style="{StaticResource ModernCheckBox}"
                              Margin="0,0,20,0"/>
                    
                    <TextBlock Text="Depth:" 
                               Foreground="{StaticResource TextSecondaryBrush}"
                               VerticalAlignment="Center"
                               Margin="0,0,8,0"/>
                    <ComboBox ItemsSource="{Binding DepthLimitOptions}"
                              SelectedItem="{Binding DepthLimit}"
                              Width="100"
                              Background="{StaticResource BackgroundLightBrush}"
                              Foreground="{StaticResource TextPrimaryBrush}">
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Converter={StaticResource DepthLimitConverter}}"/>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>
                </StackPanel>

                <!-- Settings Button -->
                <Button Grid.Column="3" Grid.Row="0"
                        Content="âš™ï¸"
                        Command="{Binding OpenSettingsCommand}"
                        Style="{StaticResource ModernButton}"
                        ToolTip="Settings"
                        FontSize="16"
                        Padding="10,6"/>

                <!-- Status -->
                <TextBlock Grid.Column="3" Grid.Row="1"
                           Text="{Binding StatusText}"
                           Foreground="{StaticResource TextSecondaryBrush}"
                           VerticalAlignment="Center"
                           TextWrapping="Wrap"
                           MaxWidth="200"
                           Margin="0,8,0,0"/>
            </Grid>
        </Border>

        <!-- Toolbar -->
        <Border Grid.Row="1" Background="{StaticResource BackgroundMediumBrush}" 
                CornerRadius="6" Padding="8" Margin="0,0,0,8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Expand/Collapse -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <Button Content="âž• Expand" 
                            Command="{Binding ExpandAllCommand}"
                            Style="{StaticResource ModernButton}"
                            Padding="8,6"
                            Margin="0,0,4,0"
                            ToolTip="Expand All"/>
                    <Button Content="âž– Collapse" 
                            Command="{Binding CollapseAllCommand}"
                            Style="{StaticResource ModernButton}"
                            Padding="8,6"
                            ToolTip="Collapse All"/>
                </StackPanel>

                <!-- Separator -->
                <Border Grid.Column="1" Width="1" Background="{StaticResource BorderBrush}" Margin="8,2"/>

                <!-- Action Buttons -->
                <StackPanel Grid.Column="2" Orientation="Horizontal">
                    <Button Content="ðŸ–¼ï¸ Set Icon" 
                            Command="{Binding SetIconCommand}"
                            Style="{StaticResource ModernButton}"
                            Padding="8,6"
                            Margin="0,0,4,0"
                            ToolTip="Set icon for selected folder (Ctrl+I)"/>
                    <Button Content="ðŸ“¥ Make Local" 
                            Command="{Binding MakeLocalCommand}"
                            Style="{StaticResource ModernButton}"
                            Padding="8,6"
                            Margin="0,0,4,0"
                            ToolTip="Extract external icon to local folder.ico"/>
                    <Button Content="â†©ï¸ Restore" 
                            Command="{Binding RestoreCommand}"
                            Style="{StaticResource ModernButton}"
                            Padding="8,6"
                            Margin="0,0,4,0"
                            ToolTip="Restore original external icon reference"/>
                    <Button Content="ðŸ—‘ï¸ Remove" 
                            Command="{Binding RemoveIconCommand}"
                            Style="{StaticResource ModernButton}"
                            Padding="8,6"
                            ToolTip="Remove custom icon"/>
                </StackPanel>

                <!-- Separator -->
                <Border Grid.Column="3" Width="1" Background="{StaticResource BorderBrush}" Margin="8,2"/>

                <!-- Filter (placeholder) -->
                <StackPanel Grid.Column="4" Orientation="Horizontal">
                    <TextBlock Text="Filter:" 
                               Foreground="{StaticResource TextSecondaryBrush}"
                               VerticalAlignment="Center"
                               Margin="0,0,8,0"/>
                    <ComboBox Width="120"
                              SelectedIndex="0"
                              Background="{StaticResource BackgroundLightBrush}"
                              Foreground="{StaticResource TextPrimaryBrush}">
                        <ComboBoxItem Content="All"/>
                        <ComboBoxItem Content="With Icons"/>
                        <ComboBoxItem Content="External Only"/>
                        <ComboBoxItem Content="Broken Only"/>
                        <ComboBoxItem Content="No Icon"/>
                    </ComboBox>
                </StackPanel>

                <!-- Summary -->
                <TextBlock Grid.Column="5" 
                           Text="{Binding SummaryText}"
                           Foreground="{StaticResource TextSecondaryBrush}"
                           VerticalAlignment="Center"/>
            </Grid>
        </Border>

        <!-- Tree View -->
        <Border Grid.Row="2" Background="{StaticResource BackgroundMediumBrush}" 
                CornerRadius="6" Margin="0,0,0,8">
            <TreeView ItemsSource="{Binding RootNodes}"
                      Background="Transparent"
                      BorderThickness="0"
                      Padding="4"
                      VirtualizingPanel.IsVirtualizing="True"
                      VirtualizingPanel.VirtualizationMode="Recycling"
                      SelectedItemChanged="TreeView_SelectedItemChanged">
                
                <TreeView.ItemContainerStyle>
                    <Style TargetType="TreeViewItem">
                        <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
                        <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}"/>
                        <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
                        <Setter Property="Padding" Value="2"/>
                        <Setter Property="Margin" Value="0,1"/>
                        <EventSetter Event="PreviewMouseRightButtonDown" Handler="TreeViewItem_PreviewMouseRightButtonDown"/>
                        <Style.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Background" Value="{StaticResource AccentBlueBrush}"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </TreeView.ItemContainerStyle>
                
                <TreeView.ItemTemplate>
                    <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                        <Grid Margin="2,3">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="24"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="70"/>
                                <ColumnDefinition Width="30"/>
                            </Grid.ColumnDefinitions>

                            <!-- Icon Thumbnail -->
                            <Image Grid.Column="0" 
                                   Source="{Binding IconImage}" 
                                   Width="20" Height="20"
                                   RenderOptions.BitmapScalingMode="HighQuality"/>

                            <!-- Folder Name -->
                            <TextBlock Grid.Column="1" 
                                       Text="{Binding Name}" 
                                       VerticalAlignment="Center"
                                       Margin="6,0,12,0"
                                       TextTrimming="CharacterEllipsis"/>

                            <!-- Source Description -->
                            <TextBlock Grid.Column="2" 
                                       Text="{Binding SourceDescription}" 
                                       Foreground="{StaticResource TextSecondaryBrush}"
                                       VerticalAlignment="Center"
                                       TextTrimming="CharacterEllipsis"
                                       MaxWidth="300"
                                       Margin="0,0,12,0"
                                       FontSize="11"/>

                            <!-- Status -->
                            <Border Grid.Column="3" 
                                    Background="{StaticResource BackgroundLightBrush}"
                                    CornerRadius="3"
                                    Padding="6,2"
                                    VerticalAlignment="Center"
                                    Visibility="{Binding HasIcon, Converter={StaticResource BoolToVisibilityConverter}}">
                                <TextBlock Text="{Binding StatusText}" 
                                           Foreground="{Binding StatusBrush}"
                                           FontSize="11"
                                           FontWeight="SemiBold"/>
                            </Border>

                            <!-- Backup Indicator -->
                            <TextBlock Grid.Column="4" 
                                       Text="{Binding BackupIndicator}" 
                                       Foreground="{StaticResource AccentGreenBrush}"
                                       VerticalAlignment="Center"
                                       HorizontalAlignment="Center"
                                       FontSize="14"
                                       ToolTip="Has backup / Source changed"/>
                        </Grid>
                    </HierarchicalDataTemplate>
                </TreeView.ItemTemplate>

                <!-- Context Menu - uses PlacementTarget to bind to main window's DataContext -->
                <TreeView.ContextMenu>
                    <ContextMenu Background="{StaticResource BackgroundMediumBrush}"
                                 DataContext="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource Self}}">
                        <MenuItem Header="ðŸ–¼ï¸ Set Icon..." 
                                  Command="{Binding SetIconCommand}"
                                  InputGestureText="Ctrl+I"/>
                        <Separator/>
                        <MenuItem Header="ðŸ“¥ Make Local (Extract)" 
                                  Command="{Binding MakeLocalCommand}"/>
                        <Separator/>
                        <MenuItem Header="â†©ï¸ Restore Original" 
                                  Command="{Binding RestoreCommand}"/>
                        <MenuItem Header="ðŸ”„ Update from Source" 
                                  Command="{Binding UpdateFromSourceCommand}"/>
                        <Separator/>
                        <MenuItem Header="ðŸ—‘ï¸ Remove Icon" 
                                  Command="{Binding RemoveIconCommand}"/>
                        <Separator/>
                        <MenuItem Header="ðŸ“‚ Open in Explorer" 
                                  Command="{Binding OpenInExplorerCommand}"
                                  InputGestureText="Ctrl+E"/>
                        <MenuItem Header="ðŸ“‹ Copy Path" 
                                  Command="{Binding CopyPathCommand}"
                                  InputGestureText="Ctrl+C"/>
                    </ContextMenu>
                </TreeView.ContextMenu>
            </TreeView>
        </Border>

        <!-- Splitter -->
        <GridSplitter Grid.Row="3" Height="4" HorizontalAlignment="Stretch" 
                      Background="Transparent" Cursor="SizeNS"/>

        <!-- Log Panel -->
        <Border Grid.Row="4" Background="{StaticResource BackgroundMediumBrush}" 
                CornerRadius="6">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Log Header -->
                <Border Grid.Row="0" Background="{StaticResource BackgroundDarkBrush}" 
                        CornerRadius="6,6,0,0" Padding="10,6">
                    <Grid>
                        <TextBlock Text="Log" 
                                   Foreground="{StaticResource TextSecondaryBrush}"
                                   FontWeight="SemiBold"/>
                        <Button Content="Clear" 
                                Command="{Binding ClearLogCommand}"
                                Style="{StaticResource ModernButton}"
                                Padding="8,3"
                                HorizontalAlignment="Right"/>
                    </Grid>
                </Border>

                <!-- Log Content -->
                <ScrollViewer Grid.Row="1" 
                              VerticalScrollBarVisibility="Auto"
                              HorizontalScrollBarVisibility="Auto">
                    <ItemsControl ItemsSource="{Binding LogEntries}" Margin="8">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding}" 
                                           FontFamily="Cascadia Code, Consolas, Courier New"
                                           FontSize="11"
                                           Foreground="{Binding Converter={StaticResource LogLevelToBrushConverter}}"
                                           Margin="0,1"/>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>
        </Border>
    </Grid>
</Window>
