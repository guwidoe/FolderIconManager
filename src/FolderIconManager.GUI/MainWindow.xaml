<Window x:Class="FolderIconManager.GUI.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:FolderIconManager.GUI"
        Title="Folder Icon Manager" 
        Height="750" Width="1100"
        MinHeight="500" MinWidth="800"
        Background="{StaticResource BackgroundDarkBrush}"
        WindowStartupLocation="CenterScreen"
        Closing="Window_Closing"
        Loaded="Window_Loaded">
    
    <Window.DataContext>
        <local:MainViewModel/>
    </Window.DataContext>

    <Window.InputBindings>
        <KeyBinding Key="I" Modifiers="Ctrl" Command="{Binding SetIconCommand}"/>
        <KeyBinding Key="E" Modifiers="Ctrl" Command="{Binding OpenInExplorerCommand}"/>
        <KeyBinding Key="C" Modifiers="Ctrl" Command="{Binding CopyPathCommand}"/>
        <KeyBinding Key="Z" Modifiers="Ctrl" Command="{Binding UndoCommand}"/>
    </Window.InputBindings>

    <Grid Margin="12">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="180"/>
        </Grid.RowDefinitions>

        <!-- Header / Folder Selection -->
        <Border Grid.Row="0" Background="{StaticResource BackgroundMediumBrush}" 
                CornerRadius="6" Padding="12" Margin="0,0,0,8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Folder Path -->
                <TextBox Grid.Column="0" Grid.Row="0"
                         Text="{Binding FolderPath, UpdateSourceTrigger=PropertyChanged}"
                         Style="{StaticResource ModernTextBox}"
                         VerticalContentAlignment="Center"
                         Margin="0,0,8,0"/>

                <!-- Browse Button -->
                <Button Grid.Column="1" Grid.Row="0"
                        Content="Browse..."
                        Command="{Binding BrowseCommand}"
                        Style="{StaticResource ModernButton}"
                        Margin="0,0,8,0"/>

                <!-- Scan Button -->
                <Button Grid.Column="2" Grid.Row="0"
                        Content="ðŸ” Scan"
                        Command="{Binding ScanCommand}"
                        Style="{StaticResource PrimaryButton}"
                        IsEnabled="{Binding CanScan}"
                        Margin="0,0,8,0"/>

                <!-- Options Row -->
                <StackPanel Grid.Column="0" Grid.Row="1" Grid.ColumnSpan="3" 
                            Orientation="Horizontal" Margin="0,10,0,0">
                    <CheckBox Content="Include subfolders" 
                              IsChecked="{Binding IncludeSubfolders}"
                              Style="{StaticResource ModernCheckBox}"
                              Margin="0,0,20,0"/>
                    
                    <TextBlock Text="Depth:" 
                               Foreground="{StaticResource TextSecondaryBrush}"
                               VerticalAlignment="Center"
                               Margin="0,0,8,0"/>
                    <ComboBox ItemsSource="{Binding DepthLimitOptions}"
                              SelectedItem="{Binding DepthLimit}"
                              Width="100"
                              Background="{StaticResource BackgroundLightBrush}"
                              Foreground="{StaticResource TextPrimaryBrush}">
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Converter={StaticResource DepthLimitConverter}}"/>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>
                </StackPanel>

                <!-- Settings Button -->
                <Button Grid.Column="3" Grid.Row="0"
                        Content="âš™ï¸"
                        Command="{Binding OpenSettingsCommand}"
                        Style="{StaticResource ModernButton}"
                        ToolTip="Settings"
                        FontSize="16"
                        Padding="10,6"/>

                <!-- Status -->
                <TextBlock Grid.Column="3" Grid.Row="1"
                           Text="{Binding StatusText}"
                           Foreground="{StaticResource TextSecondaryBrush}"
                           VerticalAlignment="Center"
                           TextWrapping="Wrap"
                           MaxWidth="200"
                           Margin="0,8,0,0"/>
            </Grid>
        </Border>

        <!-- Toolbar -->
        <Border Grid.Row="1" Background="{StaticResource BackgroundMediumBrush}" 
                CornerRadius="6" Padding="8" Margin="0,0,0,8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Expand/Collapse -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <Button Content="âž• Expand" 
                            Command="{Binding ExpandAllCommand}"
                            Style="{StaticResource ModernButton}"
                            Padding="8,6"
                            Margin="0,0,4,0"
                            ToolTip="Expand All"/>
                    <Button Content="âž– Collapse" 
                            Command="{Binding CollapseAllCommand}"
                            Style="{StaticResource ModernButton}"
                            Padding="8,6"
                            ToolTip="Collapse All"/>
                </StackPanel>

                <!-- Separator -->
                <Border Grid.Column="1" Width="1" Background="{StaticResource BorderBrush}" Margin="8,2"/>

                <!-- Action Buttons -->
                <StackPanel Grid.Column="2" Orientation="Horizontal">
                    <Button Content="ðŸ–¼ï¸ Set Icon" 
                            Command="{Binding SetIconCommand}"
                            Style="{StaticResource ModernButton}"
                            Padding="8,6"
                            Margin="0,0,4,0"
                            ToolTip="Set icon for selected folder (Ctrl+I)"/>
                    <Button Content="ðŸ“¥ Make Local" 
                            Command="{Binding MakeLocalCommand}"
                            Style="{StaticResource ModernButton}"
                            Padding="8,6"
                            Margin="0,0,4,0"
                            ToolTip="Extract external icon to local folder.ico"/>
                    <Button Content="â†©ï¸ Restore" 
                            Command="{Binding RestoreCommand}"
                            Style="{StaticResource ModernButton}"
                            Padding="8,6"
                            Margin="0,0,4,0"
                            ToolTip="Restore original external icon reference"/>
                    <Button Content="ðŸ—‘ï¸ Remove" 
                            Command="{Binding RemoveIconCommand}"
                            Style="{StaticResource ModernButton}"
                            Padding="8,6"
                            ToolTip="Remove custom icon"/>
                </StackPanel>

                <!-- Separator -->
                <Border Grid.Column="3" Width="1" Background="{StaticResource BorderBrush}" Margin="8,2"/>

                <!-- Filter Controls -->
                <StackPanel Grid.Column="4" Orientation="Horizontal">
                    <!-- Filter dropdown -->
                    <TextBlock Text="Filter:" 
                               Foreground="{StaticResource TextSecondaryBrush}"
                               VerticalAlignment="Center"
                               Margin="0,0,8,0"/>
                    <ComboBox Width="110"
                              SelectedIndex="{Binding FilterModeIndex}"
                              Background="{StaticResource BackgroundLightBrush}"
                              Foreground="{StaticResource TextPrimaryBrush}"
                              Margin="0,0,12,0">
                        <ComboBoxItem Content="All"/>
                        <ComboBoxItem Content="With Icons"/>
                        <ComboBoxItem Content="External Only"/>
                        <ComboBoxItem Content="Local Only"/>
                        <ComboBoxItem Content="Broken Only"/>
                    </ComboBox>
                    
                    <!-- Search box -->
                    <TextBlock Text="Search:" 
                               Foreground="{StaticResource TextSecondaryBrush}"
                               VerticalAlignment="Center"
                               Margin="0,0,8,0"/>
                    <TextBox Width="150"
                             Text="{Binding FilterText, UpdateSourceTrigger=PropertyChanged, Delay=300}"
                             Style="{StaticResource ModernTextBox}"
                             VerticalContentAlignment="Center"
                             Padding="6,4"/>
                </StackPanel>

                <!-- Selection / Summary -->
                <StackPanel Grid.Column="5" Orientation="Horizontal" VerticalAlignment="Center">
                    <Border Background="{StaticResource AccentBlueBrush}" 
                            CornerRadius="3" Padding="6,2" Margin="0,0,8,0"
                            Visibility="{Binding HasMultiSelection, Converter={StaticResource BoolToVisibilityConverter}}">
                        <TextBlock Text="{Binding SelectionText}" 
                                   Foreground="White" FontSize="11" FontWeight="SemiBold"/>
                    </Border>
                    <TextBlock Text="{Binding SummaryText}"
                               Foreground="{StaticResource TextSecondaryBrush}"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Tree View with Column Headers -->
        <Border Grid.Row="2" Background="{StaticResource BackgroundMediumBrush}" 
                CornerRadius="6" Margin="0,0,0,8">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Column Headers -->
                <Border Grid.Row="0" Background="{StaticResource BackgroundDarkBrush}" 
                        CornerRadius="6,6,0,0" BorderBrush="{StaticResource BorderBrush}" 
                        BorderThickness="0,0,0,1">
                    <Grid x:Name="HeaderGrid" Margin="22,0,0,0">
                        <Grid.ColumnDefinitions>
                            <!-- Name column - expander takes ~20px, so we offset the header grid -->
                            <ColumnDefinition Width="{Binding ColumnWidths.NameWidth, Mode=TwoWay}" MinWidth="100"/>
                            <ColumnDefinition Width="Auto"/>
                            <!-- Status column -->
                            <ColumnDefinition Width="{Binding ColumnWidths.StatusWidth, Mode=TwoWay}" MinWidth="60"/>
                            <ColumnDefinition Width="Auto"/>
                            <!-- Source column -->
                            <ColumnDefinition Width="{Binding ColumnWidths.SourceWidth, Mode=TwoWay}" MinWidth="100"/>
                            <ColumnDefinition Width="Auto"/>
                            <!-- Backup column -->
                            <ColumnDefinition Width="{Binding ColumnWidths.BackupWidth, Mode=TwoWay}" MinWidth="40"/>
                        </Grid.ColumnDefinitions>

                        <!-- Name Header -->
                        <Border Grid.Column="0" Padding="8,8" 
                                Visibility="{Binding ColumnWidths.NameVisible, Converter={StaticResource BoolToVisibilityConverter}}">
                            <TextBlock Text="Name" FontWeight="SemiBold" 
                                       Foreground="{StaticResource TextSecondaryBrush}"/>
                        </Border>
                        <GridSplitter Grid.Column="1" Width="4" Background="Transparent" 
                                      Cursor="SizeWE" HorizontalAlignment="Center"
                                      Visibility="{Binding ColumnWidths.NameVisible, Converter={StaticResource BoolToVisibilityConverter}}"/>

                        <!-- Status Header -->
                        <Border Grid.Column="2" Padding="8,8"
                                Visibility="{Binding ColumnWidths.StatusVisible, Converter={StaticResource BoolToVisibilityConverter}}">
                            <TextBlock Text="Status" FontWeight="SemiBold" 
                                       Foreground="{StaticResource TextSecondaryBrush}"/>
                        </Border>
                        <GridSplitter Grid.Column="3" Width="4" Background="Transparent" 
                                      Cursor="SizeWE" HorizontalAlignment="Center"
                                      Visibility="{Binding ColumnWidths.StatusVisible, Converter={StaticResource BoolToVisibilityConverter}}"/>

                        <!-- Source Header -->
                        <Border Grid.Column="4" Padding="8,8"
                                Visibility="{Binding ColumnWidths.SourceVisible, Converter={StaticResource BoolToVisibilityConverter}}">
                            <TextBlock Text="Icon Source" FontWeight="SemiBold" 
                                       Foreground="{StaticResource TextSecondaryBrush}"/>
                        </Border>
                        <GridSplitter Grid.Column="5" Width="4" Background="Transparent" 
                                      Cursor="SizeWE" HorizontalAlignment="Center"
                                      Visibility="{Binding ColumnWidths.SourceVisible, Converter={StaticResource BoolToVisibilityConverter}}"/>

                        <!-- Backup Header -->
                        <Border Grid.Column="6" Padding="8,8"
                                Visibility="{Binding ColumnWidths.BackupVisible, Converter={StaticResource BoolToVisibilityConverter}}">
                            <TextBlock Text="Backup" FontWeight="SemiBold" 
                                       Foreground="{StaticResource TextSecondaryBrush}"
                                       HorizontalAlignment="Center"/>
                        </Border>

                        <!-- Column Toggle Button -->
                        <Border Grid.Column="6" HorizontalAlignment="Right" Padding="0,4,8,4"
                                Visibility="{Binding ColumnWidths.BackupVisible, Converter={StaticResource BoolToVisibilityConverter}}">
                            <Button Content="âš™" FontSize="10" Padding="4,2" Cursor="Hand"
                                    Background="Transparent" BorderThickness="0"
                                    Foreground="{StaticResource TextSecondaryBrush}"
                                    ToolTip="Column visibility settings"
                                    Click="ColumnSettings_Click">
                                <Button.ContextMenu>
                                    <ContextMenu x:Name="ColumnContextMenu">
                                        <MenuItem Header="Name" IsCheckable="True" 
                                                  IsChecked="{Binding ColumnWidths.NameVisible, Mode=TwoWay}"/>
                                        <MenuItem Header="Status" IsCheckable="True" 
                                                  IsChecked="{Binding ColumnWidths.StatusVisible, Mode=TwoWay}"/>
                                        <MenuItem Header="Icon Source" IsCheckable="True" 
                                                  IsChecked="{Binding ColumnWidths.SourceVisible, Mode=TwoWay}"/>
                                        <MenuItem Header="Backup" IsCheckable="True" 
                                                  IsChecked="{Binding ColumnWidths.BackupVisible, Mode=TwoWay}"/>
                                        <Separator/>
                                        <MenuItem Header="Reset Columns" Click="ResetColumns_Click"/>
                                    </ContextMenu>
                                </Button.ContextMenu>
                            </Button>
                        </Border>
                    </Grid>
                </Border>

                <!-- Tree View Content -->
                <TreeView x:Name="FolderTreeView" Grid.Row="1" 
                          ItemsSource="{Binding RootNodes}"
                          Background="Transparent"
                          BorderThickness="0"
                          Padding="4"
                          VirtualizingPanel.IsVirtualizing="True"
                          VirtualizingPanel.VirtualizationMode="Recycling"
                          SelectedItemChanged="TreeView_SelectedItemChanged">
                    
                    <TreeView.ItemContainerStyle>
                        <Style TargetType="TreeViewItem">
                            <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
                            <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}"/>
                            <Setter Property="Visibility" Value="{Binding Visibility}"/>
                            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
                            <Setter Property="Padding" Value="2"/>
                            <Setter Property="Margin" Value="0,1"/>
                            <EventSetter Event="PreviewMouseLeftButtonDown" Handler="TreeViewItem_PreviewMouseLeftButtonDown"/>
                            <EventSetter Event="PreviewMouseRightButtonDown" Handler="TreeViewItem_PreviewMouseRightButtonDown"/>
                            <Style.Triggers>
                                <Trigger Property="IsSelected" Value="True">
                                    <Setter Property="Background" Value="{StaticResource AccentBlueBrush}"/>
                                </Trigger>
                                <DataTrigger Binding="{Binding IsMultiSelected}" Value="True">
                                    <Setter Property="Background" Value="#3060A0"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TreeView.ItemContainerStyle>
                    
                    <TreeView.ItemTemplate>
                        <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                            <Grid Margin="2,3">
                                <Grid.ColumnDefinitions>
                                    <!-- Name column - sync with header -->
                                    <ColumnDefinition Width="{Binding DataContext.ColumnWidths.NameWidth, RelativeSource={RelativeSource AncestorType=TreeView}}"/>
                                    <!-- Status column -->
                                    <ColumnDefinition Width="{Binding DataContext.ColumnWidths.StatusWidth, RelativeSource={RelativeSource AncestorType=TreeView}}"/>
                                    <!-- Source column -->
                                    <ColumnDefinition Width="{Binding DataContext.ColumnWidths.SourceWidth, RelativeSource={RelativeSource AncestorType=TreeView}}"/>
                                    <!-- Backup column -->
                                    <ColumnDefinition Width="{Binding DataContext.ColumnWidths.BackupWidth, RelativeSource={RelativeSource AncestorType=TreeView}}"/>
                                </Grid.ColumnDefinitions>

                                <!-- Name: Icon + Text -->
                                <StackPanel Grid.Column="0" Orientation="Horizontal"
                                            Visibility="{Binding DataContext.ColumnWidths.NameVisible, RelativeSource={RelativeSource AncestorType=TreeView}, Converter={StaticResource BoolToVisibilityConverter}}">
                                    <Image Source="{Binding IconImage}" 
                                           Width="20" Height="20"
                                           RenderOptions.BitmapScalingMode="HighQuality"
                                           Margin="0,0,6,0"/>
                                    <TextBlock Text="{Binding Name}" 
                                               VerticalAlignment="Center"
                                               TextTrimming="CharacterEllipsis"/>
                                </StackPanel>

                                <!-- Status -->
                                <Border Grid.Column="1" 
                                        Background="{StaticResource BackgroundLightBrush}"
                                        CornerRadius="3"
                                        Padding="6,2"
                                        VerticalAlignment="Center"
                                        HorizontalAlignment="Left"
                                        Margin="4,0,8,0"
                                        Visibility="{Binding HasIcon, Converter={StaticResource BoolToVisibilityConverter}}">
                                    <Border.Style>
                                        <Style TargetType="Border">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding DataContext.ColumnWidths.StatusVisible, RelativeSource={RelativeSource AncestorType=TreeView}}" Value="False">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                    <TextBlock Text="{Binding StatusText}" 
                                               Foreground="{Binding StatusBrush}"
                                               FontSize="11"
                                               FontWeight="SemiBold"/>
                                </Border>

                                <!-- Icon Source Path -->
                                <TextBlock Grid.Column="2" 
                                           Text="{Binding SourceDescription}" 
                                           Foreground="{StaticResource TextTertiaryBrush}"
                                           VerticalAlignment="Center"
                                           TextTrimming="CharacterEllipsis"
                                           Margin="4,0,8,0"
                                           FontSize="11"
                                           FontFamily="Cascadia Code, Consolas, Courier New"
                                           ToolTip="{Binding SourceDescription}"
                                           Visibility="{Binding DataContext.ColumnWidths.SourceVisible, RelativeSource={RelativeSource AncestorType=TreeView}, Converter={StaticResource BoolToVisibilityConverter}}"/>

                                <!-- Backup Indicator -->
                                <TextBlock Grid.Column="3" 
                                           Text="{Binding BackupIndicator}" 
                                           Foreground="{StaticResource AccentGreenBrush}"
                                           VerticalAlignment="Center"
                                           HorizontalAlignment="Center"
                                           FontSize="14"
                                           ToolTip="{Binding BackupTooltip}"
                                           Visibility="{Binding DataContext.ColumnWidths.BackupVisible, RelativeSource={RelativeSource AncestorType=TreeView}, Converter={StaticResource BoolToVisibilityConverter}}"/>
                            </Grid>
                        </HierarchicalDataTemplate>
                    </TreeView.ItemTemplate>

                    <!-- Context Menu -->
                    <TreeView.ContextMenu>
                        <ContextMenu Background="{StaticResource BackgroundMediumBrush}"
                                     DataContext="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource Self}}">
                            <MenuItem Header="ðŸ–¼ï¸ Set Icon..." 
                                      Command="{Binding SetIconCommand}"
                                      InputGestureText="Ctrl+I"/>
                            <Separator/>
                            <MenuItem Header="ðŸ“¥ Make Local (Extract)" 
                                      Command="{Binding MakeLocalCommand}"/>
                            <Separator/>
                            <MenuItem Header="â†©ï¸ Restore Original" 
                                      Command="{Binding RestoreCommand}"/>
                            <MenuItem Header="ðŸ”„ Update from Source" 
                                      Command="{Binding UpdateFromSourceCommand}"/>
                            <Separator/>
                            <MenuItem Header="ðŸ—‘ï¸ Remove Icon" 
                                      Command="{Binding RemoveIconCommand}"/>
                            <Separator/>
                            <MenuItem Header="ðŸ“‚ Open in Explorer" 
                                      Command="{Binding OpenInExplorerCommand}"
                                      InputGestureText="Ctrl+E"/>
                            <MenuItem Header="ðŸ“‹ Copy Path" 
                                      Command="{Binding CopyPathCommand}"
                                      InputGestureText="Ctrl+C"/>
                        </ContextMenu>
                    </TreeView.ContextMenu>
                </TreeView>
            </Grid>
        </Border>

        <!-- Splitter -->
        <GridSplitter Grid.Row="3" Height="4" HorizontalAlignment="Stretch" 
                      Background="Transparent" Cursor="SizeNS"/>

        <!-- Log Panel -->
        <Border Grid.Row="4" Background="{StaticResource BackgroundMediumBrush}" 
                CornerRadius="6">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Log Header -->
                <Border Grid.Row="0" Background="{StaticResource BackgroundDarkBrush}" 
                        CornerRadius="6,6,0,0" Padding="10,6">
                    <Grid>
                        <TextBlock Text="Log" 
                                   Foreground="{StaticResource TextSecondaryBrush}"
                                   FontWeight="SemiBold"/>
                        <Button Content="Clear" 
                                Command="{Binding ClearLogCommand}"
                                Style="{StaticResource ModernButton}"
                                Padding="8,3"
                                HorizontalAlignment="Right"/>
                    </Grid>
                </Border>

                <!-- Log Content -->
                <ScrollViewer Grid.Row="1" 
                              VerticalScrollBarVisibility="Auto"
                              HorizontalScrollBarVisibility="Auto">
                    <ItemsControl ItemsSource="{Binding LogEntries}" Margin="8">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding}" 
                                           FontFamily="Cascadia Code, Consolas, Courier New"
                                           FontSize="11"
                                           Foreground="{Binding Converter={StaticResource LogLevelToBrushConverter}}"
                                           Margin="0,1"/>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>
        </Border>
    </Grid>
</Window>
