<Window x:Class="FolderIconManager.GUI.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:FolderIconManager.GUI"
        xmlns:controls="clr-namespace:FolderIconManager.GUI.Controls"
        Title="Folder Icon Manager" 
        Height="750" Width="1100"
        MinHeight="500" MinWidth="800"
        Background="{DynamicResource BackgroundDarkBrush}"
        WindowStartupLocation="CenterScreen"
        Closing="Window_Closing"
        Loaded="Window_Loaded">
    
    <Window.DataContext>
        <local:MainViewModel/>
    </Window.DataContext>

    <Window.InputBindings>
        <KeyBinding Key="I" Modifiers="Ctrl" Command="{Binding SetIconCommand}"/>
        <KeyBinding Key="E" Modifiers="Ctrl" Command="{Binding OpenInExplorerCommand}"/>
        <KeyBinding Key="C" Modifiers="Ctrl" Command="{Binding CopyPathCommand}"/>
        <KeyBinding Key="Z" Modifiers="Ctrl" Command="{Binding UndoCommand}"/>
    </Window.InputBindings>

    <Grid Margin="12">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="180"/>
        </Grid.RowDefinitions>

        <!-- Header / Folder Selection -->
        <Border Grid.Row="0" Background="{StaticResource BackgroundMediumBrush}" 
                CornerRadius="6" Padding="12" Margin="0,0,0,8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Folder Path -->
                <TextBox Grid.Column="0" Grid.Row="0"
                         Text="{Binding FolderPath, UpdateSourceTrigger=PropertyChanged}"
                         Style="{StaticResource ModernTextBox}"
                         VerticalContentAlignment="Center"
                         Margin="0,0,8,0"/>

                <!-- Browse Button -->
                <Button Grid.Column="1" Grid.Row="0"
                        Content="Browse..."
                        Command="{Binding BrowseCommand}"
                        Style="{StaticResource ModernButton}"
                        Margin="0,0,8,0"/>

                <!-- Scan Button -->
                <Button Grid.Column="2" Grid.Row="0"
                        Content="ðŸ” Scan"
                        Command="{Binding ScanCommand}"
                        Style="{StaticResource PrimaryButton}"
                        IsEnabled="{Binding CanScan}"
                        Margin="0,0,8,0"/>

                <!-- Options Row -->
                <StackPanel Grid.Column="0" Grid.Row="1" Grid.ColumnSpan="3" 
                            Orientation="Horizontal" Margin="0,10,0,0">
                    <CheckBox Content="Include subfolders" 
                              IsChecked="{Binding IncludeSubfolders}"
                              Style="{StaticResource ModernCheckBox}"
                              Margin="0,0,20,0"/>
                    
                    <TextBlock Text="Depth:" 
                               Foreground="{StaticResource TextSecondaryBrush}"
                               VerticalAlignment="Center"
                               Margin="0,0,8,0"/>
                    <ComboBox ItemsSource="{Binding DepthLimitOptions}"
                              SelectedItem="{Binding DepthLimit}"
                              Width="100"
                              Background="{StaticResource BackgroundLightBrush}"
                              Foreground="{StaticResource TextPrimaryBrush}">
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Converter={StaticResource DepthLimitConverter}}"/>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>
                </StackPanel>

                <!-- Settings Button -->
                <Button Grid.Column="3" Grid.Row="0"
                        Content="âš™ï¸"
                        Command="{Binding OpenSettingsCommand}"
                        Style="{StaticResource ModernButton}"
                        ToolTip="Settings"
                        FontSize="16"
                        Padding="10,6"/>

                <!-- Status -->
                <TextBlock Grid.Column="3" Grid.Row="1"
                           Text="{Binding StatusText}"
                           Foreground="{StaticResource TextSecondaryBrush}"
                           VerticalAlignment="Center"
                           TextWrapping="Wrap"
                           MaxWidth="200"
                           Margin="0,8,0,0"/>
            </Grid>
        </Border>

        <!-- Toolbar -->
        <Border Grid.Row="1" Background="{StaticResource BackgroundMediumBrush}" 
                CornerRadius="6" Padding="8" Margin="0,0,0,8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Expand/Collapse -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <Button Content="âž• Expand" 
                            Command="{Binding ExpandAllCommand}"
                            Style="{StaticResource ModernButton}"
                            Padding="8,6"
                            Margin="0,0,4,0"
                            ToolTip="Expand All"/>
                    <Button Content="âž– Collapse" 
                            Command="{Binding CollapseAllCommand}"
                            Style="{StaticResource ModernButton}"
                            Padding="8,6"
                            ToolTip="Collapse All"/>
                </StackPanel>

                <!-- Separator -->
                <Border Grid.Column="1" Width="1" Background="{StaticResource BorderBrush}" Margin="8,2"/>

                <!-- Action Buttons -->
                <StackPanel Grid.Column="2" Orientation="Horizontal">
                    <Button Content="ðŸ–¼ï¸ Set Icon" 
                            Command="{Binding SetIconCommand}"
                            Style="{StaticResource ModernButton}"
                            Padding="8,6"
                            Margin="0,0,4,0"
                            ToolTip="Set icon for selected folder (Ctrl+I)"/>
                    <Button Content="ðŸ“¥ Make Local" 
                            Command="{Binding MakeLocalCommand}"
                            Style="{StaticResource ModernButton}"
                            Padding="8,6"
                            Margin="0,0,4,0"
                            ToolTip="Extract external icon to local folder.ico"/>
                    <Button Content="â†©ï¸ Restore" 
                            Command="{Binding RestoreCommand}"
                            Style="{StaticResource ModernButton}"
                            Padding="8,6"
                            Margin="0,0,4,0"
                            ToolTip="Restore original external icon reference"/>
                    <Button Content="ðŸ—‘ï¸ Remove" 
                            Command="{Binding RemoveIconCommand}"
                            Style="{StaticResource ModernButton}"
                            Padding="8,6"
                            ToolTip="Remove custom icon"/>
                </StackPanel>

                <!-- Separator -->
                <Border Grid.Column="3" Width="1" Background="{StaticResource BorderBrush}" Margin="8,2"/>

                <!-- Filter Controls -->
                <StackPanel Grid.Column="4" Orientation="Horizontal">
                    <!-- Filter dropdown -->
                    <TextBlock Text="Filter:" 
                               Foreground="{StaticResource TextSecondaryBrush}"
                               VerticalAlignment="Center"
                               Margin="0,0,8,0"/>
                    <ComboBox Width="110"
                              SelectedIndex="{Binding FilterModeIndex}"
                              Background="{StaticResource BackgroundLightBrush}"
                              Foreground="{StaticResource TextPrimaryBrush}"
                              Margin="0,0,12,0">
                        <ComboBoxItem Content="All"/>
                        <ComboBoxItem Content="With Icons"/>
                        <ComboBoxItem Content="External Only"/>
                        <ComboBoxItem Content="Local Only"/>
                        <ComboBoxItem Content="Broken Only"/>
                    </ComboBox>
                    
                    <!-- Search box -->
                    <TextBlock Text="Search:" 
                               Foreground="{StaticResource TextSecondaryBrush}"
                               VerticalAlignment="Center"
                               Margin="0,0,8,0"/>
                    <TextBox Width="150"
                             Text="{Binding FilterText, UpdateSourceTrigger=PropertyChanged, Delay=300}"
                             Style="{StaticResource ModernTextBox}"
                             VerticalContentAlignment="Center"
                             Padding="6,4"/>
                </StackPanel>

                <!-- Selection / Summary -->
                <StackPanel Grid.Column="5" Orientation="Horizontal" VerticalAlignment="Center">
                    <Border Background="{StaticResource AccentBlueBrush}" 
                            CornerRadius="3" Padding="6,2" Margin="0,0,8,0"
                            Visibility="{Binding HasMultiSelection, Converter={StaticResource BoolToVisibilityConverter}}">
                        <TextBlock Text="{Binding SelectionText}" 
                                   Foreground="White" FontSize="11" FontWeight="SemiBold"/>
                    </Border>
                    <TextBlock Text="{Binding SummaryText}"
                               Foreground="{StaticResource TextSecondaryBrush}"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Tree List View with proper columns -->
        <Border Grid.Row="2" Background="{DynamicResource BackgroundMediumBrush}" 
                CornerRadius="6" Margin="0,0,0,8">
            <ListView x:Name="FolderListView"
                      ItemsSource="{Binding FilteredNodesView}"
                      SelectedItem="{Binding SelectedNode, Mode=TwoWay}"
                      Background="Transparent"
                      BorderThickness="0"
                      Foreground="{DynamicResource TextPrimaryBrush}"
                      VirtualizingPanel.IsVirtualizing="True"
                      VirtualizingPanel.VirtualizationMode="Recycling"
                      SelectionMode="Extended"
                      SelectionChanged="ListView_SelectionChanged">

                <ListView.View>
                    <GridView AllowsColumnReorder="True"
                              ColumnHeaderContainerStyle="{StaticResource TreeListViewColumnHeaderStyle}">
                        
                        <!-- Name Column -->
                        <GridViewColumn Header="Name" Width="280">
                            <GridViewColumn.CellTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal" 
                                                Margin="{Binding Level, Converter={StaticResource TreeLevelToIndentConverter}}">
                                        <!-- Expander Toggle -->
                                        <ToggleButton Style="{StaticResource TreeListViewExpanderStyle}"
                                                      IsChecked="{Binding IsExpanded, Mode=TwoWay}"
                                                      Visibility="{Binding HasChildren, Converter={StaticResource BoolToVisibilityConverter}}"
                                                      Margin="0,0,4,0"/>
                                        <!-- Spacer when no expander -->
                                        <Border Width="20" 
                                                Visibility="{Binding HasChildren, Converter={StaticResource InverseBoolToVisibilityConverter}}"/>
                                        <!-- Folder Icon -->
                                        <Image Source="{Binding IconImage}" 
                                               Width="20" Height="20"
                                               RenderOptions.BitmapScalingMode="HighQuality"
                                               Margin="0,0,6,0"/>
                                        <!-- Folder Name -->
                                        <TextBlock Text="{Binding Name}" 
                                                   VerticalAlignment="Center"
                                                   TextTrimming="CharacterEllipsis"/>
                                    </StackPanel>
                                </DataTemplate>
                            </GridViewColumn.CellTemplate>
                        </GridViewColumn>

                        <!-- Status Column -->
                        <GridViewColumn Header="Status" Width="80">
                            <GridViewColumn.CellTemplate>
                                <DataTemplate>
                                    <Border Background="{DynamicResource BackgroundLightBrush}"
                                            CornerRadius="3"
                                            Padding="6,2"
                                            HorizontalAlignment="Left"
                                            Visibility="{Binding HasIcon, Converter={StaticResource BoolToVisibilityConverter}}">
                                        <TextBlock Text="{Binding StatusText}" 
                                                   Foreground="{Binding StatusBrush}"
                                                   FontSize="11"
                                                   FontWeight="SemiBold"/>
                                    </Border>
                                </DataTemplate>
                            </GridViewColumn.CellTemplate>
                        </GridViewColumn>

                        <!-- Icon Source Column -->
                        <GridViewColumn Header="Icon Source" Width="300">
                            <GridViewColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding SourceDescription}" 
                                               Foreground="{DynamicResource TextTertiaryBrush}"
                                               VerticalAlignment="Center"
                                               TextTrimming="CharacterEllipsis"
                                               FontSize="11"
                                               FontFamily="Cascadia Code, Consolas, Courier New"
                                               ToolTip="{Binding SourceDescription}"/>
                                </DataTemplate>
                            </GridViewColumn.CellTemplate>
                        </GridViewColumn>

                        <!-- Attributes Column -->
                        <GridViewColumn Header="Attrs" Width="55">
                            <GridViewColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding AttributeStatusIcon}" 
                                               Foreground="{Binding AttributeStatusBrush}"
                                               VerticalAlignment="Center"
                                               HorizontalAlignment="Center"
                                               FontSize="14"
                                               ToolTip="{Binding AttributeTooltip}"/>
                                </DataTemplate>
                            </GridViewColumn.CellTemplate>
                        </GridViewColumn>

                        <!-- Backup Column -->
                        <GridViewColumn Header="Backup" Width="60">
                            <GridViewColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding BackupIndicator}" 
                                               Foreground="{DynamicResource AccentGreenBrush}"
                                               VerticalAlignment="Center"
                                               HorizontalAlignment="Center"
                                               FontSize="14"
                                               ToolTip="{Binding BackupTooltip}"/>
                                </DataTemplate>
                            </GridViewColumn.CellTemplate>
                        </GridViewColumn>
                    </GridView>
                </ListView.View>

                <ListView.ItemContainerStyle>
                    <Style TargetType="ListViewItem">
                        <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                        <Setter Property="Padding" Value="4,3"/>
                        <Setter Property="Margin" Value="0"/>
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="ListViewItem">
                                    <Border x:Name="Bd"
                                            Background="{TemplateBinding Background}"
                                            BorderBrush="{TemplateBinding BorderBrush}"
                                            BorderThickness="{TemplateBinding BorderThickness}"
                                            Padding="{TemplateBinding Padding}"
                                            SnapsToDevicePixels="True">
                                        <GridViewRowPresenter Content="{TemplateBinding Content}"
                                                              Columns="{Binding View.Columns, RelativeSource={RelativeSource AncestorType=ListView}}"
                                                              VerticalAlignment="Center"/>
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsSelected" Value="True">
                                            <Setter TargetName="Bd" Property="Background" Value="{DynamicResource AccentBlueBrush}"/>
                                        </Trigger>
                                        <MultiTrigger>
                                            <MultiTrigger.Conditions>
                                                <Condition Property="IsSelected" Value="False"/>
                                                <Condition Property="IsMouseOver" Value="True"/>
                                            </MultiTrigger.Conditions>
                                            <Setter TargetName="Bd" Property="Background" Value="{DynamicResource BackgroundLightBrush}"/>
                                        </MultiTrigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </ListView.ItemContainerStyle>

                <!-- Context Menu -->
                <ListView.ContextMenu>
                    <ContextMenu Background="{DynamicResource BackgroundMediumBrush}"
                                 DataContext="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource Self}}">
                        <MenuItem Header="ðŸ–¼ï¸ Set Icon..." 
                                  Command="{Binding SetIconCommand}"
                                  InputGestureText="Ctrl+I"/>
                        <Separator/>
                        <MenuItem Header="ðŸ“¥ Make Local (Extract)" 
                                  Command="{Binding MakeLocalCommand}"/>
                        <MenuItem Header="ðŸ”§ Fix Attributes" 
                                  Command="{Binding FixAttributesCommand}"
                                  ToolTip="Fix folder/file attributes to make custom icon display"/>
                        <Separator/>
                        <MenuItem Header="â†©ï¸ Restore Original" 
                                  Command="{Binding RestoreCommand}"/>
                        <MenuItem Header="ðŸ”„ Update from Source" 
                                  Command="{Binding UpdateFromSourceCommand}"/>
                        <Separator/>
                        <MenuItem Header="ðŸ—‘ï¸ Remove Icon" 
                                  Command="{Binding RemoveIconCommand}"/>
                        <Separator/>
                        <MenuItem Header="ðŸ“‚ Open in Explorer" 
                                  Command="{Binding OpenInExplorerCommand}"
                                  InputGestureText="Ctrl+E"/>
                        <MenuItem Header="ðŸ“‹ Copy Path" 
                                  Command="{Binding CopyPathCommand}"
                                  InputGestureText="Ctrl+C"/>
                        <MenuItem Header="ðŸ“‹ Copy Icon Source Path" 
                                  Command="{Binding CopyIconSourcePathCommand}"/>
                    </ContextMenu>
                </ListView.ContextMenu>
            </ListView>
        </Border>

        <!-- Splitter -->
        <GridSplitter Grid.Row="3" Height="4" HorizontalAlignment="Stretch" 
                      Background="Transparent" Cursor="SizeNS"/>

        <!-- Log Panel -->
        <Border Grid.Row="4" Background="{StaticResource BackgroundMediumBrush}" 
                CornerRadius="6">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Log Header -->
                <Border Grid.Row="0" Background="{StaticResource BackgroundDarkBrush}" 
                        CornerRadius="6,6,0,0" Padding="10,6">
                    <Grid>
                        <TextBlock Text="Log" 
                                   Foreground="{StaticResource TextSecondaryBrush}"
                                   FontWeight="SemiBold"/>
                        <Button Content="Clear" 
                                Command="{Binding ClearLogCommand}"
                                Style="{StaticResource ModernButton}"
                                Padding="8,3"
                                HorizontalAlignment="Right"/>
                    </Grid>
                </Border>

                <!-- Log Content -->
                <ListBox Grid.Row="1" 
                         ItemsSource="{Binding LogEntries}" 
                         SelectionMode="Extended"
                         Background="Transparent"
                         BorderThickness="0"
                         Margin="8"
                         VirtualizingPanel.IsVirtualizing="True"
                         ScrollViewer.HorizontalScrollBarVisibility="Auto">
                    <ListBox.ItemContainerStyle>
                        <Style TargetType="ListBoxItem">
                            <Setter Property="Padding" Value="2,1"/>
                            <Setter Property="Background" Value="Transparent"/>
                            <Setter Property="BorderThickness" Value="0"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="ListBoxItem">
                                        <Border Background="{TemplateBinding Background}" 
                                                Padding="{TemplateBinding Padding}">
                                            <ContentPresenter/>
                                        </Border>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                            <Style.Triggers>
                                <Trigger Property="IsSelected" Value="True">
                                    <Setter Property="Background" Value="#33FFFFFF"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </ListBox.ItemContainerStyle>
                    <ListBox.ContextMenu>
                        <ContextMenu>
                            <MenuItem Header="Copy Selected" Command="ApplicationCommands.Copy"/>
                            <MenuItem Header="Select All" Command="ApplicationCommands.SelectAll"/>
                        </ContextMenu>
                    </ListBox.ContextMenu>
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding}" 
                                       FontFamily="Cascadia Code, Consolas, Courier New"
                                       FontSize="11"
                                       Foreground="{Binding Converter={StaticResource LogLevelToBrushConverter}}"/>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </Grid>
        </Border>
    </Grid>
</Window>
